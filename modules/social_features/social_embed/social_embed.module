<?php

/**
 * @file
 * The Social Embed module.
 */

use Drupal\Core\Cache\Cache;
use Drupal\Core\Entity\EntityForm;
use Drupal\Core\File\FileSystemInterface;

use Drupal\Core\Form\FormStateInterface;
use Drupal\embed\Entity\EmbedButton;
use Drupal\file\Entity\File;
use Drupal\user\Entity\User;

/**
 * Function that creates an embed button with a custom icon.
 */
function _social_embed_create_media_button() {

  // Create a File entity for the icon.
  $path = drupal_get_path('module', 'social_embed');
  $image_path = $path . DIRECTORY_SEPARATOR . 'assets' . DIRECTORY_SEPARATOR . 'icons' . DIRECTORY_SEPARATOR . 'urlembed.png';
  $uri = \Drupal::service('file_system')->copy($image_path, 'public://urlembed.png', FileSystemInterface::EXISTS_REPLACE);

  $media = File::create([
    'langcode' => 'en',
    'uid' => 1,
    'status' => 1,
    'uri' => $uri,
  ]);
  $media->save();

  // Create an embed icon.
  $button = EmbedButton::create([
    'id' => 'social_embed',
    'label' => t('Media'),
    'langcode' => 'en',
    'status' => TRUE,
    'icon_uuid' => $media->uuid(),
    'type_id' => 'url',
    'type_settings' => [],
  ]);
  $button->save();

}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function social_embed_form_user_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Add options to enable embedded content consent settings for the current
  // user.
  $current_user = \Drupal::currentUser();
  $user = NULL;
  if (\Drupal::config('social_embed.settings')->get('embed_consent_settings')
    && ($form_state->getFormObject() instanceof EntityForm)
    && ($user = $form_state->getFormObject()->getEntity() && $user instanceof User)
    && ($user->hasField('field_user_embed_content_consent'))
    && ($user->id() == $current_user->id())
  ) {
    /** @var \Drupal\user\Entity\User $user */
    $form['actions']['submit']['#submit'][] = '_social_embed_form_user_form_submit';
  }
}

/**
 * Save embed content consent settings a user.
 */
function _social_embed_form_user_form_submit($form, FormStateInterface $form_state) {
  $uid = $form_state->getValue('uid');

  $user_consent_settings = $form_state->getValue(['field_user_embed_content_consent']);

  if ($form['field_user_embed_content_consent']['widget']['value']['#default_value'] != $user_consent_settings['value']) {
    // Let's invalidate our custom tags so that render cache of such content
    // can be rebuilt and the effect of changed settings can take place.
    // @see: SocialEmbedConvertUrlToEmbedFilter
    // @see: SocialEmbedUrlEmbedFilter
    // @see: SocialEmbedHelper::addDependencies()
    Cache::invalidateTags(["social_embed.filter.$uid"]);
  }
}
